#!/bin/bash -e
# bin/compile <build-dir>

BUILD_DIR=$1
ESCAPED_BUILD_DIR=$(echo $BUILD_DIR | sed -e 's/[\/&]/\\&/g')
BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)

curl -sSL https://raw.githubusercontent.com/cyberark/summon/master/install.sh | sed -e 's/sudo //' -e "s/\/usr\/local\/bin/$ESCAPED_BUILD_DIR/" -e "s/-d \"\/etc\/bash_completion.d\"/\! 1/" | bash
curl -sSL https://raw.githubusercontent.com/cyberark/summon-conjur/master/install.sh | sed -e 's/sudo //' -e "s/\/usr\/local\/lib\/summon/$ESCAPED_BUILD_DIR/" | bash

pushd $BUILD_DIR
  mkdir -p ".profile.d"
  cp $ROOT_DIR/lib/0000_retrieve-secrets.sh ./.profile.d/0000_retrieve-secrets.sh
popd
